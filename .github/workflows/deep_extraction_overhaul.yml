name: Deep Extraction Overhaul
on: [workflow_dispatch]

jobs:
  overhaul:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Inject Reactive Activity Engine
        run: |
          mkdir -p src/data src/components src/hooks

          # 1. Stage-Specific Event & Activity Database
          cat << 'EOF' > src/data/activities.ts
          export const ACTIVITIES = {
            ACADEMY: [
              { id: 'a_01', minAge: 3, maxAge: 5, label: 'Coloring Books', effects: { intelligence: 2, focus: 3 }, desc: 'Practice staying within the lines.' },
              { id: 'a_02', minAge: 4, maxAge: 6, label: 'Read with Parents', effects: { intelligence: 5, social: 2 }, desc: 'Absorb the basics of literacy.' }
            ],
            STADIUM: [
              { id: 's_01', minAge: 3, maxAge: 6, label: 'Running Drills', effects: { fitness: 5, health: 2 }, desc: 'Basic coordination and speed work.' },
              { id: 's_02', minAge: 5, maxAge: 10, label: 'Youth Football', effects: { fitness: 3, social: 5 }, desc: 'Join a local Wembley youth team.' }
            ],
            HUSTLE: [
              { id: 'h_01', minAge: 6, maxAge: 12, label: 'Household Chores', effects: { wealth: 2, focus: 2 }, desc: 'Earn a small allowance for helping out.' }
            ]
          };

          export const NARRATIVE_EVENTS = {
            0: { title: 'First Breath', narrative: 'The simulation begins. You are a biological anomaly in Wembley.', choices: [{ text: 'Observe', effects: { focus: 5 } }] },
            3: { title: 'The Sandbox', narrative: 'You notice the other kids are slower than you. How do you spend your time?', choices: [
              { text: 'Lead the Group', effects: { influence: 5, social: 5 } },
              { text: 'Study the Toys', effects: { intelligence: 5, focus: 5 } },
              { text: 'Climb the Fence', effects: { fitness: 5, health: -2 } }
            ]}
          };
          EOF

          # 2. Updated Game Loop for Age Correlation
          cat << 'EOF' > src/hooks/useGameLoop.ts
          import { useGameStore } from '../store/gameStore';
          import { NARRATIVE_EVENTS } from '../data/activities';

          export function useGameLoop() {
            const { gameState, incrementAge, setCurrentEvent } = useGameStore();

            const advanceLife = () => {
              const nextAge = gameState.current_age + 1;
              incrementAge();
              const event = NARRATIVE_EVENTS[nextAge];
              setCurrentEvent(event || { 
                title: `Year ${nextAge}`, 
                narrative: 'The timeline continues without major external interference.',
                choices: [{ text: 'Continue', effects: { focus: 1 } }]
              });
            };

            return { advanceLife };
          }
          EOF

          # 3. Functional Activity Tabs
          cat << 'EOF' > src/components/GameContainer.tsx
          import React from 'react';
          import { useGameStore } from '../store/gameStore';
          import { useGameLoop } from '../hooks/useGameLoop';
          import { ACTIVITIES } from '../data/activities';

          export function GameContainer() {
            const { gameState, currentEvent, activeTab, setTab, applyChoice } = useGameStore();
            const { advanceLife } = useGameLoop();

            const renderTabContent = () => {
              const currentActivities = ACTIVITIES[activeTab] || [];
              const available = currentActivities.filter(a => gameState.current_age >= a.minAge && gameState.current_age <= a.maxAge);

              if (activeTab === 'STORY') {
                return (
                  <div className="space-y-8">
                    <div className="space-y-4">
                      <h3 className="text-4xl font-light text-[#fafafa] leading-tight">{currentEvent?.title || "Passive State"}</h3>
                      <p className="text-lg text-[#71717a] font-light italic leading-relaxed">{currentEvent?.narrative}</p>
                    </div>
                    <div className="space-y-3">
                      {currentEvent?.choices?.map((c, i) => (
                        <button key={i} onClick={() => applyChoice(c.effects)} className="w-full py-4 border border-[#c2410c]/40 text-[10px] uppercase tracking-[0.2em] hover:bg-[#c2410c]">{c.text}</button>
                      ))}
                    </div>
                  </div>
                );
              }

              return (
                <div className="space-y-6">
                  <h3 className="text-[#c2410c] uppercase tracking-[0.4em] text-[10px] mb-8">{activeTab} MODULE</h3>
                  {available.length > 0 ? available.map(a => (
                    <button key={a.id} onClick={() => applyChoice(a.effects)} className="w-full p-6 bg-[#0d0d0d] border border-[#1c1c1f] text-left hover:border-[#c2410c] transition-all group">
                      <div className="flex justify-between items-center mb-2">
                        <span className="text-sm text-[#fafafa] group-hover:text-[#c2410c] transition-colors">{a.label}</span>
                        <span className="text-[8px] text-[#3f3f46] uppercase">Active</span>
                      </div>
                      <p className="text-[10px] text-[#71717a] leading-relaxed">{a.desc}</p>
                    </button>
                  )) : <div className="text-[10px] text-[#3f3f46] uppercase tracking-[0.4em] py-20 text-center">No available interactions at Age {gameState.current_age}</div>}
                </div>
              );
            };

            return (
              <div className="min-h-screen bg-[#0a0a0a] text-[#d4d4d8] flex flex-col font-serif">
                {/* Minimalist HUD */}
                <div className="p-6 border-b border-[#1c1c1f] flex justify-between items-end">
                  <div className="flex flex-col">
                    <span className="text-[8px] text-[#3f3f46] uppercase tracking-widest">Subject: {gameState.name}</span>
                    <span className="text-2xl font-light text-[#fafafa]">Year {gameState.current_age}</span>
                  </div>
                  <span className="text-[9px] font-mono text-[#c2410c] uppercase px-3 py-1 border border-[#c2410c]/20">Stage: {gameState.current_stage}</span>
                </div>

                <div className="flex-1 p-8 overflow-y-auto">{renderTabContent()}</div>

                <div className="bg-[#0d0d0d] border-t border-[#1c1c1f]">
                  <div className="grid grid-cols-4">
                    {['STORY', 'ACADEMY', 'STADIUM', 'HUSTLE'].map(t => (
                      <button key={t} onClick={() => setTab(t)} className={`py-5 text-[8px] tracking-[0.2em] uppercase transition-all ${activeTab === t ? 'text-[#c2410c] bg-[#141414]' : 'text-[#3f3f46]'}`}>{t}</button>
                    ))}
                  </div>
                  <button onClick={advanceLife} className="w-full py-6 bg-[#c2410c] text-white text-[10px] tracking-[0.5em] uppercase hover:bg-orange-600 active:scale-95 transition-all">Advance Timeline</button>
                </div>
              </div>
            );
          }
          EOF

      - name: Force Push
        run: |
          git config --global user.name "Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Engine: Deep Extraction Overhaul - Conditional Activities & Minimalist HUD" || echo "no changes"
          git push origin main --force
