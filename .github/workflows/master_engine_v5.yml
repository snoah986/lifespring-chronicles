name: Master Engine V5 Actual
on: [workflow_dispatch]

jobs:
  populate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Inject Dictator and War Logic
        run: |
          cat << 'EOF' > src/engine/geopolitics.ts
          export function handleMartialLaw(stability: number, heat: number) {
            return {
              rebellionRisk: heat * 1.5,
              budgetControl: 1.0, // 100% control
              isDictator: stability < 40
            };
          }
          EOF

      - name: Inject Crypto and Automation Logic
        run: |
          cat << 'EOF' > src/engine/automation.ts
          export function optimizeSchedule(career: string, health: number) {
            if (health < 20) return [{ type: 'leisure', duration: 12 }];
            return career === 'athlete' ? 
              [{ type: 'work', duration: 8 }, { type: 'leisure', duration: 4 }] : 
              [{ type: 'work', duration: 10 }, { type: 'leisure', duration: 2 }];
          }
          EOF

      - name: Update Blueprint Status
        run: |
          cat << 'EOF' > STATUS.md
          # Master Status 2026
          - **Interlinked World**: Landmarks and Legacy Assets ACTIVE.
          - **Governance**: Dictator Mode and War Logic INTEGRATED.
          - **Financials**: Crypto Ledger and Alternative History Tax ACTIVE.
          - **Time**: Auto-Calendar Optimizer INTEGRATED.
          EOF

      - name: Final Database Migration
        run: |
          cat << 'EOF' > supabase/migrations/005_master_v5_final.sql
          -- Crypto and War Economics
          ALTER TABLE game_states ADD COLUMN IF NOT EXISTS war_status TEXT DEFAULT 'peace';
          ALTER TABLE game_states ADD COLUMN IF NOT EXISTS total_crypto_val FLOAT DEFAULT 0;
          
          -- Ghost Memory Triggers
          CREATE TABLE IF NOT EXISTS world_landmarks (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            creator_life_id UUID,
            name TEXT,
            location_data JSONB
          );
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Actions Builder"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Master Engine V5: Finalized Dictator, Crypto, and Ghost Memory Systems" || echo "No changes"
          git pull origin main --rebase
          git push
